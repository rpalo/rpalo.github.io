<!DOCTYPE html>
<html lang="en">
    <head>
        
        <!-- Bootstrap Setup -->
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <!--<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">-->
        
        <!-- Custom CSS -->
        <link rel="stylesheet" href="/css/main.css">
        <link rel="stylesheet" href="/css/syntax.css">
        
        <title>assert_not magic?</title>
    </head>
    <body>
        
<nav id="main-nav">
    <a href="/" class="mobile-home">assert_not magic?</a>
    <ul>
        <li class="logo"><a href="/">assert_not magic?</a></li>
        <li><a href="/posts/">All Posts</a></li>
        <li><a href="/about/">About</a></li>
        <li><a href="/sketches/">Sketches</a></li>
        <li><a href="/todo/">To-Do</a></li>
    </ul>
</nav>
        <div class="container main">
                <article class="site-wrap">
    <h1>Cache Me Outside</h1>
    <p>I just came across a little nugget of wisdom after reading <a href="https://www.amin.space/blog/2017/5/elemental_speller/">this blog post</a> about making words out of Periodic Table Elements.  I highly recommend the read.  However, that’s not why we’re here.  We’re here to cache in on some of the benefits of Python’s standard library.  </p>

<p>For those that don’t know, caching is really useful for when a function is getting called with the same arguments repeatedly and you can expect the same result each time.  Instead of calculating the result each time, you save the result in your cache for later.  This is especially useful for functions that intrinsically take a long time to run, like API calls, file I/O, or super-duper nested loops.  Consider, for a moment, our humble friend the Fibonacci function.  In Python, a common (but grossly inefficient) version goes something like this:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">fibonacci</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Finds the nth fibonacci number.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">n</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]:</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">fibonacci</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">fibonacci</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span></code></pre></div>

<p>It looks really nice and is pretty understandable.  But imagine it running at even <code>n = 5</code>.  Here’s a rough version of the call-stack:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">fibonacci</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">fibonacci</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">fibonacci</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">fibonacci</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="o">=</span> <span class="mi">2</span>
    <span class="n">fibonacci</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">fibonacci</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">fibonacci</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">fibonacci</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">fibonacci</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="o">=</span> <span class="mi">2</span>
        <span class="o">=</span> <span class="mi">3</span>
<span class="o">----------------</span>
<span class="mi">2</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">=</span> <span class="mf">5.</span></code></pre></div>

<p>And that’s only at # 5.  You can see how <code>fibonacci(2)</code> gets called <em>three times!</em>  Imagine what would happen if you tried to calculate <code>n = 10</code> or <code>n = 100</code>!  Don’t worry.  I did.  Actually, for <code>n = 100</code> I got too bored waiting for it to finish up.  In fact, I couldn’t even wait for <code>n = 50</code> to finish!  Even <code>n = 35</code> took like 7 seconds or so.  This is where the cache comes in.  You could probably make your own without too much trouble.  I tried a version way back in <a href="/2017/02/02/default-argument-tricks">this blog post</a>.  It came out pretty good if I do say so myself.  The only problem with adding a cache to a function is that it takes up a good number of lines of code and obscures what you actually want to show the function doing.  There are ways around that too, but why struggle and fight with that problem when the standard library (<em>trumpet fanfare</em>) has got you covered?</p>

<p>BEHOLD.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">lru_cache</span>
<span class="c"># You should really look at the functools docs.</span>
<span class="c"># I mean it, there&#39;s some awesome stuff in there!</span>
<span class="c"># Also, FYI, LRU stands for Least Recently Used</span>
<span class="c"># which is the item that gets booted from the cache when</span>
<span class="c"># it hits its limit</span>

<span class="nd">@lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span> <span class="c"># Works best with maxsize as a power of 2.</span>
<span class="k">def</span> <span class="nf">fibonacci</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Finds the nth fibonacci number.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">n</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]:</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">fibonacci</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">fibonacci</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span></code></pre></div>

<p>Notice how I didn’t even change the main function?  I just thought to myself, “Oh, caching might be nice to have here,” and sprinkled a little decorator on top.  I’ll have to talk about decorators in another post, but just know that they’re used to augment functions, usually to add side-effects like registering a function somewhere or, like you might expect, adding a cache.  How much benefit did we gain?  </p>

<p>Without the cache:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>python3 -m cProfile fib.py -n 40
102334155
         <span class="m">204668315</span> <span class="k">function</span> calls <span class="o">(</span><span class="m">7</span> primitive calls<span class="o">)</span> in 89.028 seconds</code></pre></div>

<p>Wowza.  With the cache:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>python3 -m cProfile fib.py -n 300
222232244629420445529739893461909967206666939096499764990979600
         <span class="m">323</span> <span class="k">function</span> calls <span class="o">(</span><span class="m">24</span> primitive calls<span class="o">)</span> in 0.001 seconds</code></pre></div>

<p>How bow dah?</p>

    <small>
        
        <a href="/tags/python/">python</a>
        
        <a href="/tags/tricks/">tricks</a>
        
    </small>
</div>
        </div>

        <footer id="main-footer">
    <div class="container">
        <p class="text-muted">&copy; Ryan Palo 2017 | All things.  Phil. 4:13</p>
    </div>
</footer>
        <!-- Scripts -->
        <!--  
        jQuery (necessary for Bootstrap's JavaScript plugins)
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
        Latest compiled and minified Bootstrap JavaScript
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
        -->
        <!-- Custom Javascript -->
        <script src="/js/main.js"></script>
        
    </body>
</html>